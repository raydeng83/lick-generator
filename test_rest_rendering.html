<!DOCTYPE html>
<html>
<head>
  <title>Test Rest Rendering - Midpoint Rule</title>
  <script src="https://unpkg.com/vexflow@4.2.2/build/cjs/vexflow.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #output {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 300px;
    }
    .test-case {
      margin: 20px 0;
      padding: 10px;
      background: #f5f5f5;
    }
    .test-case h3 {
      margin-top: 0;
    }
    .pass {
      color: green;
      font-weight: bold;
    }
    .fail {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Rest Rendering - Midpoint Rule Test</h1>
  <p>This test verifies that rests in the notation are broken at the measure midpoint (beat 2 of each 4/4 measure).</p>

  <div id="test-results"></div>

  <h2>Visual Output:</h2>
  <div id="output"></div>

  <script src="./web/scales.js"></script>
  <script src="./web/melodic-cells.js"></script>
  <script src="./web/devices-new.js"></script>
  <script src="./web/generator.js"></script>
  <script src="./web/notate.js"></script>

  <script>
    const testResults = document.getElementById('test-results');
    const output = document.getElementById('output');

    // Generate a lick with rests
    const progression = [
      { symbol: 'Dm7', bar: 0, startBeat: 0, durationBeats: 4 },
      { symbol: 'G7', bar: 1, startBeat: 4, durationBeats: 4 },
      { symbol: 'Cmaj7', bar: 2, startBeat: 8, durationBeats: 4 }
    ];

    const options = {
      scaleStrategy: 'default',
      deviceStrategy: 'neighbor-enclosure',
      swing: 0,
      insertRests: false
    };

    // Generate multiple licks to find ones with rests
    let testCount = 0;
    let passCount = 0;
    let failCount = 0;

    for (let i = 0; i < 20; i++) {
      const lick = window.LickGen.generateLick(progression, { tempo: 120 }, options);
      const rests = lick.filter(n => n.isRest);

      if (rests.length > 0) {
        testCount++;

        const testDiv = document.createElement('div');
        testDiv.className = 'test-case';

        let hasViolations = false;
        let resultHTML = `<h3>Test Case ${testCount}</h3>`;

        rests.forEach((rest, idx) => {
          const endBeat = rest.startBeat + rest.durationBeats;
          const measureStart = Math.floor(rest.startBeat / 4) * 4;
          const midpoint = measureStart + 2;
          const crossesMidpoint = rest.startBeat < midpoint && endBeat > midpoint;

          resultHTML += `<p>Rest ${idx + 1}: beat ${rest.startBeat.toFixed(1)} to ${endBeat.toFixed(1)} (duration ${rest.durationBeats})`;

          if (crossesMidpoint) {
            resultHTML += ` <span class="fail">❌ CROSSES MIDPOINT at ${midpoint}</span>`;
            hasViolations = true;
          } else {
            resultHTML += ` <span class="pass">✓ OK</span>`;
          }

          resultHTML += '</p>';
        });

        if (hasViolations) {
          failCount++;
          resultHTML = `<div class="fail">FAIL</div>` + resultHTML;
        } else {
          passCount++;
          resultHTML = `<div class="pass">PASS</div>` + resultHTML;
        }

        testDiv.innerHTML = resultHTML;
        testResults.appendChild(testDiv);

        // Render the first failing case
        if (hasViolations && failCount === 1) {
          const renderDiv = document.createElement('div');
          renderDiv.style.marginTop = '20px';
          output.appendChild(renderDiv);

          window.Notate.render({
            container: renderDiv,
            progression: progression,
            lick: lick,
            metadata: { tempo: 120, timeSig: '4/4' },
            useColors: true
          });
        }

        // Stop after finding 5 cases with rests
        if (testCount >= 5) break;
      }
    }

    // Summary
    const summaryDiv = document.createElement('div');
    summaryDiv.style.marginTop = '20px';
    summaryDiv.style.padding = '10px';
    summaryDiv.style.background = '#e3f2fd';
    summaryDiv.innerHTML = `
      <h2>Summary</h2>
      <p>Total tests: ${testCount}</p>
      <p class="pass">Passed: ${passCount}</p>
      <p class="fail">Failed: ${failCount}</p>
    `;
    testResults.insertBefore(summaryDiv, testResults.firstChild);

    // If no rests found, show message
    if (testCount === 0) {
      testResults.innerHTML = '<p>No licks with rests were generated in 20 attempts. Try running the test again.</p>';
    }
  </script>
</body>
</html>
