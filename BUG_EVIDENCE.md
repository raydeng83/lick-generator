# Bug Evidence: Chromatic Notes Incorrectly Labeled in Arpeggio Device

## User Report
"When selecting Arpeggio + Scale mix, I'm still seeing chromatic notes marked with green or blue color."

## Test Results

**Test file:** `test_arpeggio_scale_mix_chromatic.js`

**Command:** `node test_arpeggio_scale_mix_chromatic.js`

### Summary
- **Total notes generated:** 1,120 (across 50 licks)
- **Chromatic notes found:** 64
- **Incorrectly labeled chromatic notes:** 14
- **Error rate:** 21.9% of chromatic notes are mislabeled

### Breakdown
All 14 incorrectly labeled chromatic notes have:
- **Incorrect label:** `harmonicFunction='chord-tone'`
- **Correct label should be:** `harmonicFunction='chromatic'`
- **Device:** All from `arpeggio` device
- **Rule:** All have `ruleId='arpeggio'`

### Example Cases

#### Example 1: Db4 in Dm7 context
- Note: Db4 (MIDI 61, pitch class 1)
- Chord: Dm7 (root pitch class 2)
- Scale: D Dorian (pitch classes: [2, 4, 5, 7, 9, 11, 0])
- Note interval from root: 11 (major 7th)
- **In chord:** false
- **In scale:** false (Db is NOT in D Dorian)
- **Actual label:** `harmonicFunction='chord-tone'` ❌
- **Expected label:** `harmonicFunction='chromatic'` ✓

#### Example 2: Bb4 in G7 context
- Note: Bb4 (MIDI 70, pitch class 10)
- Chord: G7 (root pitch class 7)
- Scale: G Mixolydian (pitch classes: [7, 9, 11, 0, 2, 4, 5])
- Note interval from root: 3 (minor 3rd)
- **In chord:** false (G7 has intervals [0, 4, 7, 10], Bb is interval 3)
- **In scale:** false (Bb/10 is NOT in G Mixolydian)
- **Actual label:** `harmonicFunction='chord-tone'` ❌
- **Expected label:** `harmonicFunction='chromatic'` ✓

## Root Cause Analysis

### Location in Code
**File:** `/Users/ledeng/projects/lick-generator/web/devices-new.js`

### Bug #1: Main Arpeggio Loop (Lines 106-118)
The arpeggio device generates notes by cycling through chord tones, but it **hardcodes** `harmonicFunction: 'chord-tone'` without validating that the note is in the scale.

```javascript
// Lines 106-118
notes.push({
  startBeat: measureStart + i * 0.5,
  durationBeats: 0.5,
  midi,
  velocity: 0.9,
  device: 'arpeggio',
  chordSymbol: chord.symbol,
  rootPc,
  quality,
  scaleName: scale,
  ruleId: 'arpeggio',
  harmonicFunction: 'chord-tone',  // ❌ BUG: No validation!
});
```

**Problem:** The code assumes that because it selected `midi` from `chordAbs` (absolute chord pitch classes), it's automatically a chord tone. However, this MIDI note might not be in the scale, making it a chromatic note.

**Why this happens:**
1. Arpeggio device calculates chord tones: `const chordAbs = chordPcs.map(pc => (rootPc + pc) % 12);`
2. It cycles through these pitch classes across octaves
3. Due to octave adjustments and range clamping (lines 93-95), the resulting MIDI note might land on a pitch class that's NOT in the current scale
4. The code never checks `isInScale(midi, scalePcs)`

### Bug #2: Last Note of Arpeggio (Lines 126-138)
Same issue - hardcoded `harmonicFunction: 'chord-tone'` without scale validation.

```javascript
// Lines 126-138
if (!isLastMeasure) {
  notes.push({
    startBeat: measureStart + 3.5,
    durationBeats: 0.5,
    midi: currentMidi,
    velocity: 0.9,
    device: 'arpeggio',
    chordSymbol: chord.symbol,
    rootPc,
    quality,
    scaleName: scale,
    ruleId: 'arpeggio',
    harmonicFunction: 'chord-tone',  // ❌ BUG: No validation!
  });
}
```

### Why Last Measure Path (Lines 30-58) is Correct
The last measure path correctly implements three-way logic:

```javascript
// Lines 37-54 (CORRECT implementation)
for (let i = 1; i < 7; i++) {
  currentMidi = nextScaleNote(currentMidi, rootPc, scalePcs, direction);
  const isChordToneNote = isChordTone(currentMidi, rootPc, chordPcs);
  const inScale = isInScale(currentMidi, scalePcs);  // ✓ Checks scale

  notes.push({
    startBeat: measureStart + i * 0.5,
    durationBeats: 0.5,
    midi: currentMidi,
    velocity: 0.9,
    device: 'arpeggio',
    chordSymbol: chord.symbol,
    rootPc,
    quality,
    scaleName: scale,
    ruleId: isChordToneNote ? 'arpeggio' : 'scale-step',
    harmonicFunction: isChordToneNote ? 'chord-tone' : (inScale ? 'scale-step' : 'chromatic'),  // ✓ CORRECT
  });
}
```

## Impact

When using `deviceStrategy: 'arpeggio-scale-mix'`:
- 50% of measures use the arpeggio device
- 21.9% of chromatic notes generated by arpeggio are mislabeled
- These chromatic notes display as **blue** (chord-tone color) instead of **orange** (chromatic color)
- This misleads users about the harmonic function of the notes

## Color Mapping Reference
From `/Users/ledeng/projects/lick-generator/web/notate.js`:
- **Blue (#4cc3ff):** `harmonicFunction='chord-tone'`
- **Green (#34c759):** `harmonicFunction='scale-step'`
- **Orange (#ff9500):** `harmonicFunction='chromatic'`

## Required Fix

Both locations need to add scale validation:

**Line 106-118:** Add `isInScale()` check and three-way logic
**Line 126-138:** Add `isInScale()` check and three-way logic

The fix should match the pattern used in the last measure path (lines 37-54) and all other devices.
